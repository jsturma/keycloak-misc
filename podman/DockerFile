# -----------------------------------------------------------------------------
# Keycloak 26.x (Quarkus) - Podman compatible
# Multi-architecture support: x86_64 (amd64) and arm64
# Builds from Debian base with JDK and Keycloak tar.gz
# 
# This Dockerfile always works for both amd64 and arm64 architectures.
# For official Keycloak image (if available), see DockerFile.official
# -----------------------------------------------------------------------------

# Build arguments
ARG TARGETPLATFORM
ARG BUILDPLATFORM
ARG KEYCLOAK_VERSION=26.4.7

# Base image: Debian (supports both amd64 and arm64)
# Using bookworm (Debian 12) which includes OpenJDK 21
FROM --platform=$TARGETPLATFORM debian:bookworm-slim

# Install all packages and set up Java environment in a single layer
# This reduces image size by combining operations and cleaning up in the same layer
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        curl \
        tar \
        gzip \
        ca-certificates \
        openjdk-21-jdk \
        && \
    ARCH=$(dpkg --print-architecture) && \
    if [ "$ARCH" = "amd64" ]; then \
        JAVA_HOME="/usr/lib/jvm/java-21-openjdk-amd64"; \
    elif [ "$ARCH" = "arm64" ]; then \
        JAVA_HOME="/usr/lib/jvm/java-21-openjdk-arm64"; \
    else \
        JAVA_HOME="/usr/lib/jvm/java-21-openjdk-${ARCH}"; \
    fi && \
    echo "export JAVA_HOME=${JAVA_HOME}" >> /etc/profile.d/java.sh && \
    echo "export PATH=${JAVA_HOME}/bin:\${PATH}" >> /etc/profile.d/java.sh && \
    chmod +x /etc/profile.d/java.sh && \
    echo "source /etc/profile.d/java.sh" >> /etc/bash.bashrc && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Set JAVA_HOME environment variable (architecture-specific)
# Will be set correctly by the profile script, but set a default for immediate use
ENV JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
ENV PATH="${JAVA_HOME}/bin:${PATH}"

# Create keycloak user and download Keycloak in a single layer
ARG KEYCLOAK_VERSION=26.4.7
RUN groupadd -r keycloak && \
    useradd -r -g keycloak -u 1000 -d /opt/keycloak -s /sbin/nologin keycloak && \
    mkdir -p /opt && \
    curl -fsSL "https://github.com/keycloak/keycloak/releases/download/${KEYCLOAK_VERSION}/keycloak-${KEYCLOAK_VERSION}.tar.gz" | \
    tar -xzC /opt && \
    mv /opt/keycloak-${KEYCLOAK_VERSION} /opt/keycloak && \
    chown -R keycloak:keycloak /opt/keycloak && \
    rm -rf /tmp/* /var/tmp/*

# Set working directory
WORKDIR /opt/keycloak

# Optional: custom themes / providers
# COPY themes /opt/keycloak/themes
# COPY providers/*.jar /opt/keycloak/providers/

# Ensure correct ownership for rootless Podman and build Keycloak
# Combined into single layer to reduce image size
RUN chown -R 1000:0 /opt/keycloak && \
    /opt/keycloak/bin/kc.sh build || echo "Build step skipped or failed, will build at runtime"

# Drop privileges
USER 1000

# Expose HTTPS only (no HTTP)
EXPOSE 8443

# Entrypoint
ENTRYPOINT ["/opt/keycloak/bin/kc.sh"]
CMD ["start-dev"]
